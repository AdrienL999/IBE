import it.unisa.dia.gas.jpbc.Element;
import it.unisa.dia.gas.jpbc.Pairing;
import it.unisa.dia.gas.plaf.jpbc.pairing.PairingFactory;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Arrays;
import java.util.Base64;
import java.util.Properties;
import java.util.concurrent.TimeUnit;

public class IBE1 {
    public static void setup(String pairingParametersFileName, String pkFileName, String mskFileName) {
        Pairing bp = PairingFactory.getPairing(pairingParametersFileName);

        Element x = bp.getZr().newRandomElement().getImmutable();
        Properties mskProp = new Properties();
        mskProp.setProperty("x", Base64.getEncoder().encodeToString(x.toBytes()));
        storePropToFile(mskProp, mskFileName);

        Element g = bp.getG1().newRandomElement().getImmutable();
        Element g_x = g.duplicate().powZn(x); // g^x
        Properties pkProp = new Properties();
        pkProp.setProperty("g", Base64.getEncoder().encodeToString(g.toBytes()));
        pkProp.setProperty("g_x", Base64.getEncoder().encodeToString(g_x.toBytes())); // ‰øùÂ≠ò g^x
        storePropToFile(pkProp, pkFileName);
    }

    public static void keygen(String pairingParametersFileName, String id, 
                             String mskFileName, String skFileName) 
            throws NoSuchAlgorithmException {
        Pairing bp = PairingFactory.getPairing(pairingParametersFileName);

        byte[] idHash = sha1(id);
        Element QID = bp.getG1().newElementFromHash(idHash, 0, idHash.length).getImmutable();

        Properties mskProp = loadPropFromFile(mskFileName);
        String xString = mskProp.getProperty("x");
        Element x = bp.getZr().newElementFromBytes(Base64.getDecoder().decode(xString)).getImmutable();

        Element sk = QID.powZn(x).getImmutable(); // QID^x
        Properties skProp = new Properties();
        skProp.setProperty("sk", Base64.getEncoder().encodeToString(sk.toBytes()));
        storePropToFile(skProp, skFileName);
    }

    public static void encrypt(String pairingParametersFileName, String id, 
                              String message, String ctFileName, String pkFileName) 
            throws NoSuchAlgorithmException {
        Pairing bp = PairingFactory.getPairing(pairingParametersFileName);

        byte[] idHash = sha1(id);
        Element QID = bp.getG1().newElementFromHash(idHash, 0, idHash.length).getImmutable();

        Properties pkProp = loadPropFromFile(pkFileName);
        String gString = pkProp.getProperty("g");
        Element g = bp.getG1().newElementFromBytes(Base64.getDecoder().decode(gString)).getImmutable();
        
        String g_xString = pkProp.getProperty("g_x");
        // ‰øÆÊ≠£Ôºög_x ÊòØ G1 ÂÖÉÁ¥†Ôºå‰∏çÊòØ Zr ÂÖÉÁ¥†
        Element g_x = bp.getG1().newElementFromBytes(Base64.getDecoder().decode(g_xString)).getImmutable();

        Element r = bp.getZr().newRandomElement().getImmutable();
        Element C1 = g.duplicate().powZn(r); // g^r
        
        // ËÆ°ÁÆó e(QID, g_x)^r
        Element gID = bp.pairing(QID, g_x).powZn(r).getImmutable(); 

        // ÈáçË¶ÅÊîπËøõÔºöÁõ¥Êé•‰ΩøÁî®Â≠óËäÇÊï∞ÁªÑÔºåÈÅøÂÖçÂ≠óÁ¨¶‰∏≤ËΩ¨Êç¢ÊçüÂùèÊï∞ÊçÆ
        byte[] HgID = sha1(gID.toBytes());
        byte[] messageBytes = message.getBytes();
        byte[] C2 = new byte[messageBytes.length];
        for (int i=0; i<messageBytes.length; i++) {
            int hashPos = i % HgID.length;  // Âæ™ÁéØ‰ΩøÁî®ÂìàÂ∏åÂ≠óËäÇ
            C2[i] = (byte) (messageBytes[i] ^ HgID[hashPos]);
        }
//        for (int i = 0; i < messageBytes.length; i++) {
//            C2[i] = (byte) (messageBytes[i] ^ HgID[i % HgID.length]);
//        }

        Properties ctProp = new Properties();
        ctProp.setProperty("C1", Base64.getEncoder().encodeToString(C1.toBytes()));
        ctProp.setProperty("C2", Base64.getEncoder().encodeToString(C2));
        storePropToFile(ctProp, ctFileName);
    }

    public static String decrypt(String pairingParametersFileName, 
                                String skFileName, String ctFileName) 
            throws NoSuchAlgorithmException {
        Pairing bp = PairingFactory.getPairing(pairingParametersFileName);

        Properties skProp = loadPropFromFile(skFileName);
        String skString = skProp.getProperty("sk");
        Element sk = bp.getG1().newElementFromBytes(Base64.getDecoder().decode(skString)).getImmutable();

        // ‰øÆÊ≠£Ôºö‰ªéÂØÜÊñáÊñá‰ª∂ËØªÂèñÂØÜÊñáÔºåËÄå‰∏çÊòØ‰ªéÁßÅÈí•Êñá‰ª∂
        Properties ctProp = loadPropFromFile(ctFileName);
        String C1String = ctProp.getProperty("C1");
        Element C1 = bp.getG1().newElementFromBytes(Base64.getDecoder().decode(C1String)).getImmutable();
        
        String C2String = ctProp.getProperty("C2");
        byte[] C2 = Base64.getDecoder().decode(C2String);

        // ËÆ°ÁÆó e(sk, C1) = e(QID^x, g^r)
        Element gID = bp.pairing(sk, C1).getImmutable();

        // ÈáçË¶ÅÊîπËøõÔºöÁõ¥Êé•‰ΩøÁî®Â≠óËäÇÊï∞ÁªÑ
        byte[] HgID = sha1(gID.toBytes());
        byte[] messageBytes = new byte[C2.length];
        for (int i = 0; i < C2.length; i++) {
            messageBytes[i] = (byte) (C2[i] ^ HgID[i % HgID.length]);
        }
        return new String(messageBytes);
    }

    private static Properties loadPropFromFile(String fileName) {
        Properties prop = new Properties();
        try (FileInputStream in = new FileInputStream(fileName)) {
            prop.load(in);
        } catch (IOException e) {
            System.err.println("‚ùå Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: " + fileName);
            System.err.println("ÈîôËØØÂéüÂõ†: " + e.getMessage());
            throw new RuntimeException("Êó†Ê≥ïÂä†ËΩΩÈÖçÁΩÆÊñá‰ª∂: " + fileName, e);
        }
        return prop;
    }

    private static byte[] sha1(String content) throws NoSuchAlgorithmException {
        MessageDigest md = MessageDigest.getInstance("SHA-1");
        md.update(content.getBytes());
        return md.digest();
    }
    
    // ÈáçËΩΩÊñπÊ≥ïÔºöÁõ¥Êé•Â§ÑÁêÜÂ≠óËäÇÊï∞ÁªÑ
    private static byte[] sha1(byte[] data) throws NoSuchAlgorithmException {
        MessageDigest md = MessageDigest.getInstance("SHA-1");
        return md.digest(data);
    }

    public static void storePropToFile(Properties prop, String fileName) {
        try {
            // Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
            Path path = Paths.get(fileName);
            Path parentDir = path.getParent();
            
            if (parentDir != null && !Files.exists(parentDir)) {
                Files.createDirectories(parentDir);
                System.out.println("‚úÖ ÂàõÂª∫ÁõÆÂΩï: " + parentDir);
            }
            
            // ‰øùÂ≠òÊñá‰ª∂
            try (OutputStream out = Files.newOutputStream(path)) {
                prop.store(out, "IBE System Parameters");
                System.out.println("üíæ ÊàêÂäü‰øùÂ≠ò: " + fileName);
            }
        } catch (IOException e) {
            System.err.println("‚ùå ‰øùÂ≠òÂ§±Ë¥•: " + fileName);
            System.err.println("ÈîôËØØËØ¶ÊÉÖ: " + e.getMessage());
            throw new RuntimeException("Êó†Ê≥ï‰øùÂ≠òÊñá‰ª∂: " + fileName, e);
        }
    }

    public static void performanceTest() throws Exception {
        // ÊµãËØïÂèÇÊï∞
        String pairingParametersFileName = "a.properties";
        String dir = "data/";
        String pkFileName = dir + "pk.properties";
        String mskFileName = dir + "msk.properties";
        String skFileName = dir + "sk.properties";
        String ctFileName = dir + "ct.properties";
        String testID = "test@performance.com";

        // ÁîüÊàêÁ≤æÁ°ÆÈïøÂ∫¶ÁöÑÊµãËØïÊ∂àÊÅØ
        String baseMsg = "ÊµãËØïÊ∂àÊÅØ1234567890"; // 20Â≠óËäÇ(UTF-8)
        StringBuilder longMsg = new StringBuilder();
        for(int i=0; i<256; i++) { // ÁîüÊàê5KBÂ∑¶Âè≥ÁöÑÊ∂àÊÅØ
            longMsg.append(baseMsg);
        }
        String message = longMsg.toString();

        System.out.println("=== IBE ÊÄßËÉΩÊµãËØïÂºÄÂßã ===");
        System.out.printf("ÊµãËØïÊ∂àÊÅØÈïøÂ∫¶: %d Â≠óËäÇ\n", message.getBytes().length);

        // 1. SetupÈò∂ÊÆµÊÄßËÉΩ
        long start = System.nanoTime();
        setup(pairingParametersFileName, pkFileName, mskFileName);
        long setupTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);

        // 2. KeyGenÈò∂ÊÆµÊÄßËÉΩ
        start = System.nanoTime();
        keygen(pairingParametersFileName, testID, mskFileName, skFileName);
        long keygenTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);

        // 3. Âä†ÂØÜÊÄßËÉΩÊµãËØï
        int[] messageLengths = {64, 256, 1024, 4096}; // Â≠óËäÇ
        long[] encryptTimes = new long[messageLengths.length];

        for(int i=0; i<messageLengths.length; i++) {
            byte[] msgBytes = Arrays.copyOf(message.getBytes(), messageLengths[i]);
            String testMsg = new String(msgBytes, "UTF-8");

            start = System.nanoTime();
            encrypt(pairingParametersFileName, testID, testMsg, ctFileName, pkFileName);
            encryptTimes[i] = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);
        }

        // 4. Ëß£ÂØÜÊÄßËÉΩ
        start = System.nanoTime();
        String decrypted = decrypt(pairingParametersFileName, skFileName, ctFileName);
        long decryptTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);

        // ÊâìÂç∞ÁªìÊûú
        System.out.println("\n„ÄêÊ†∏ÂøÉÊìç‰ΩúËÄóÊó∂„Äë");
        System.out.printf("Setup: %d ms\n", setupTime);
        System.out.printf("KeyGen: %d ms\n", keygenTime);
        System.out.printf("Decrypt: %d ms\n", decryptTime);

        System.out.println("\n„ÄêÂä†ÂØÜÂêûÂêêÈáè„Äë");
        for(int i=0; i<messageLengths.length; i++) {
            double throughput = (messageLengths[i] * 1000.0) / encryptTimes[i]; // bytes/sec
            System.out.printf("%dÂ≠óËäÇÊ∂àÊÅØ => %d ms (%.2f KB/s)\n",
                    messageLengths[i], encryptTimes[i], throughput/1024);
        }

        // ÂÜÖÂ≠òÂç†Áî®ÂàÜÊûê
        Runtime runtime = Runtime.getRuntime();
        System.out.println("\n„ÄêÂÜÖÂ≠ò‰ΩøÁî®„Äë");
        System.out.printf("ÊÄªÂÜÖÂ≠ò: %.2f MB\n", runtime.totalMemory() / (1024.0 * 1024));
        System.out.printf("Á©∫Èó≤ÂÜÖÂ≠ò: %.2f MB\n", runtime.freeMemory() / (1024.0 * 1024));
    }

    public static void main(String[] args) throws Exception {
        // Á°Æ‰øùÈÖçÂØπÂèÇÊï∞Êñá‰ª∂Â≠òÂú®
        String pairingParamsFile = "a.properties";
        File paramFile = new File(pairingParamsFile);
        if (!paramFile.exists()) {
            System.err.println("‚ùå ÈÖçÂØπÂèÇÊï∞Êñá‰ª∂‰∏çÂ≠òÂú®: " + paramFile.getAbsolutePath());
            System.err.println("ËØ∑‰ªé JPBC Â∫ì‰∏≠Ëé∑ÂèñÂèÇÊï∞Êñá‰ª∂");
            System.exit(1);
        }

        String idBob = "bob@example.com";
        String idAlice = "alice@example.com";
        String message = "Hello, IBE Encryption! ‰Ω†Â•ΩÔºåÂü∫‰∫éË∫´‰ªΩÁöÑÂä†ÂØÜÔºÅ";
        
        // ‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑ
        String dir = "data/";
        String pkFileName = dir + "pk.properties";
        String mskFileName = dir + "msk.properties";
        String skFileName = dir + "sk.properties";
        String ctFileName = dir + "ct.properties";

        // 1. ÂàùÂßãÂåñÁ≥ªÁªü
        setup(pairingParamsFile, pkFileName, mskFileName);
        
        // 2. ÁîüÊàêÁî®Êà∑ÂØÜÈí•Ôºà‰øÆÊ≠£ÂèÇÊï∞È°∫Â∫èÔºâ
        keygen(pairingParamsFile, idBob, mskFileName, skFileName);
        
        // 3. Âä†ÂØÜÊ∂àÊÅØÔºà‰øÆÊ≠£ÂèÇÊï∞È°∫Â∫èÔºâ
        encrypt(pairingParamsFile, idBob, message, ctFileName, pkFileName);
        
        // 4. Ëß£ÂØÜÊ∂àÊÅØ
        String decrypted = decrypt(pairingParamsFile, skFileName, ctFileName);
        
        System.out.println("\n=======================================");
        System.out.println("ÂéüÂßãÊ∂àÊÅØ: " + message);
        System.out.println("Ëß£ÂØÜÊ∂àÊÅØ: " + decrypted);
        System.out.println("Ëß£ÂØÜ" + (message.equals(decrypted) ? "ÊàêÂäü ‚úÖ" : "Â§±Ë¥• ‚ùå"));
        System.out.println("=======================================");

        performanceTest();
    }
}